title: Implementation: PR Preview Deployment
tags: Documentation Design Implementation

!! Challenge: Reviewing Changes

When maintainers receive a wiki edit issue, they need to see how the changes will look in the actual wiki before merging. This requires deploying preview versions of the wiki.

!! Solution: Per-PR GitHub Pages Deployment

GitHub Pages supports deploying from GitHub Actions, and we can use this to create preview deployments for each pull request.

!! Approach 1: GitHub Pages with Subdirectories (Recommended)

Each PR gets deployed to a subdirectory of the GitHub Pages site.

!!! URL Structure

* Main wiki: `https://anicolao.github.io/practical-copilot-wiki/`
* PR #42 preview: `https://anicolao.github.io/practical-copilot-wiki/pr-42/`
* PR #43 preview: `https://anicolao.github.io/practical-copilot-wiki/pr-43/`

!!! Implementation

# Create a new GitHub Actions workflow: `.github/workflows/pr-preview.yml`
# On PR events (opened, synchronized), build the wiki
# Checkout the `gh-pages` branch
# Create/update a `pr-{number}` directory with the build output
# Commit and push to `gh-pages` branch
# Comment on the PR with the preview URL

!!! Workflow File Structure

```yaml
name: PR Preview Deployment

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'wiki/tiddlers/**'
      - 'wiki/tiddlywiki.info'

jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build wiki
        run: npm run build
      
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
      
      - name: Deploy to preview directory
        run: |
          mkdir -p gh-pages/pr-${{ github.event.pull_request.number }}
          cp -r wiki/output/* gh-pages/pr-${{ github.event.pull_request.number }}/
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Deploy preview for PR #${{ github.event.pull_request.number }}"
          git push
      
      - name: Comment preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = `https://anicolao.github.io/practical-copilot-wiki/pr-${context.issue.number}/`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üîç Preview deployed to: ${previewUrl}`
            })
```

!!! Cleanup

Create a workflow to remove preview directories when PRs are closed:

```yaml
name: Cleanup PR Preview

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
      
      - name: Remove preview directory
        run: |
          rm -rf pr-${{ github.event.pull_request.number }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Remove preview for PR #${{ github.event.pull_request.number }}"
          git push
```

!! Approach 2: Cloudflare Pages / Netlify (Alternative)

Third-party services like Cloudflare Pages and Netlify offer free preview deployments with their own URLs.

!!! Benefits

* Each PR gets a unique, isolated URL
* Automatic SSL certificates
* Better performance and CDN
* Automatic cleanup

!!! Drawbacks

* Requires third-party account and integration
* Additional configuration complexity
* May have build minute limits

!!! Example with Cloudflare Pages

Cloudflare Pages can be configured to automatically build and deploy each PR:

* Main site: `practical-copilot-wiki.pages.dev`
* PR previews: `{commit-hash}.practical-copilot-wiki.pages.dev`

This requires:
# Creating a Cloudflare account
# Connecting the GitHub repository
# Configuring build settings
# No additional workflows needed

!! Recommended Approach

For this project, ''Approach 1 (GitHub Pages with subdirectories)'' is recommended because:

* No third-party dependencies
* Full control over deployment
* Free and unlimited
* Consistent with existing setup
* Simple to understand and maintain

!! Path Configuration for TiddlyWiki

When deploying to a subdirectory, TiddlyWiki may need path configuration for proper resource loading. This is handled by:

* Ensuring the wiki is built as a single self-contained HTML file (current setup)
* No additional configuration needed for single-file wikis

!! Security Considerations

* Preview deployments should not require authentication
* Preview URLs are public but not easily discoverable
* Old preview directories should be cleaned up after PR closure
* Preview branches should not be merged directly to main
